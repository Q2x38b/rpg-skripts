# =========================================================
# Equipment GUI (Hypixel Skyblock Style)
# Armor slots, stats display, and accessory slots
# =========================================================

options:
  admin_perm: tablevels.admin

# ----------------------------
# Helpers
# ----------------------------

function eq_cc(t: text) :: text:
  set {_s} to {_t}
  replace all "&" with "ยง" in {_s}
  return {_s}

function eq_uid(p: player) :: text:
  return "%uuid of {_p}%"

function eq_isAccessory(i: item) :: boolean:
  if {_i} is not set:
    return false
  if {_i} is air:
    return false
  if lore of {_i} is not set:
    return false
  loop lore of {_i}:
    if loop-value contains "ACCESSORY":
      return true
  return false

function eq_getStatFromLore(i: item, statName: text) :: number:
  if {_i} is not set:
    return 0
  if {_i} is air:
    return 0
  if lore of {_i} is not set:
    return 0
  loop lore of {_i}:
    set {_l} to loop-value
    if {_l} contains {_statName}:
      set {_t} to {_l}
      replace all {_statName} with "" in {_t}
      replace all ":" with "" in {_t}
      replace all "+" with "" in {_t}
      replace all " " with "" in {_t}
      # Remove color codes more carefully
      replace all "&a" with "" in {_t}
      replace all "&b" with "" in {_t}
      replace all "&c" with "" in {_t}
      replace all "&d" with "" in {_t}
      replace all "&e" with "" in {_t}
      replace all "&f" with "" in {_t}
      replace all "&l" with "" in {_t}
      replace all "&8" with "" in {_t}
      replace all "&7" with "" in {_t}
      replace all "&" with "" in {_t}
      set {_n} to {_t} parsed as number
      if {_n} is set:
        return {_n}
  return 0

function eq_recalcStats(p: player):
  set {_u} to eq_uid({_p})
  
  # Reset stats
  set {equip::hp::%{_u}%} to 0
  set {equip::mana::%{_u}%} to 0
  set {equip::speed::%{_u}%} to 0
  set {equip::fortune::%{_u}%} to 0
  
  # Check armor
  if helmet of {_p} is set:
    add eq_getStatFromLore(helmet of {_p}, "Health") to {equip::hp::%{_u}%}
    add eq_getStatFromLore(helmet of {_p}, "Mana") to {equip::mana::%{_u}%}
    add eq_getStatFromLore(helmet of {_p}, "Mining Speed") to {equip::speed::%{_u}%}
    add eq_getStatFromLore(helmet of {_p}, "Mining Fortune") to {equip::fortune::%{_u}%}
  if chestplate of {_p} is set:
    add eq_getStatFromLore(chestplate of {_p}, "Health") to {equip::hp::%{_u}%}
    add eq_getStatFromLore(chestplate of {_p}, "Mana") to {equip::mana::%{_u}%}
    add eq_getStatFromLore(chestplate of {_p}, "Mining Speed") to {equip::speed::%{_u}%}
    add eq_getStatFromLore(chestplate of {_p}, "Mining Fortune") to {equip::fortune::%{_u}%}
  if leggings of {_p} is set:
    add eq_getStatFromLore(leggings of {_p}, "Health") to {equip::hp::%{_u}%}
    add eq_getStatFromLore(leggings of {_p}, "Mana") to {equip::mana::%{_u}%}
    add eq_getStatFromLore(leggings of {_p}, "Mining Speed") to {equip::speed::%{_u}%}
    add eq_getStatFromLore(leggings of {_p}, "Mining Fortune") to {equip::fortune::%{_u}%}
  if boots of {_p} is set:
    add eq_getStatFromLore(boots of {_p}, "Health") to {equip::hp::%{_u}%}
    add eq_getStatFromLore(boots of {_p}, "Mana") to {equip::mana::%{_u}%}
    add eq_getStatFromLore(boots of {_p}, "Mining Speed") to {equip::speed::%{_u}%}
    add eq_getStatFromLore(boots of {_p}, "Mining Fortune") to {equip::fortune::%{_u}%}
  
  # Check accessories
  loop {equip::accessories::%{_u}%::*}:
    set {_acc} to loop-value
    if {_acc} is set:
      if eq_isAccessory({_acc}) is true:
        add eq_getStatFromLore({_acc}, "Health") to {equip::hp::%{_u}%}
        add eq_getStatFromLore({_acc}, "Mana") to {equip::mana::%{_u}%}
        add eq_getStatFromLore({_acc}, "Mining Speed") to {equip::speed::%{_u}%}
        add eq_getStatFromLore({_acc}, "Mining Fortune") to {equip::fortune::%{_u}%}

# ----------------------------
# Equipment GUI
# ----------------------------

function eq_openEquipmentGui(p: player):
  set {_u} to eq_uid({_p})
  eq_recalcStats({_p})
  
  set {_inv} to chest inventory with 6 rows named eq_cc("&8Equipment")
  
  # Fill all slots with glass panes with hover text indicating what goes in each slot
  set {_i} to 0
  while {_i} < 54:
    set {_glass} to black stained glass pane
    set {_slotName} to ""
    set {_slotDesc} to ""
    
    # Armor slots with descriptive text
    if {_i} is 10:
      set {_glass} to gray stained glass pane
      set {_slotName} to eq_cc("&7Helmet Slot")
      set {_slotDesc} to eq_cc("&8Place a helmet here")
    else if {_i} is 19:
      set {_glass} to gray stained glass pane
      set {_slotName} to eq_cc("&7Chestplate Slot")
      set {_slotDesc} to eq_cc("&8Place a chestplate here")
    else if {_i} is 28:
      set {_glass} to gray stained glass pane
      set {_slotName} to eq_cc("&7Leggings Slot")
      set {_slotDesc} to eq_cc("&8Place leggings here")
    else if {_i} is 37:
      set {_glass} to gray stained glass pane
      set {_slotName} to eq_cc("&7Boots Slot")
      set {_slotDesc} to eq_cc("&8Place boots here")
    # Accessory slots
    else if {_i} is 16:
      set {_glass} to light gray stained glass pane
      set {_slotName} to eq_cc("&7Necklace Slot")
      set {_slotDesc} to eq_cc("&8Place an accessory here")
    else if {_i} is 25:
      set {_glass} to light gray stained glass pane
      set {_slotName} to eq_cc("&7Ring Slot")
      set {_slotDesc} to eq_cc("&8Place an accessory here")
    else if {_i} is 34:
      set {_glass} to light gray stained glass pane
      set {_slotName} to eq_cc("&7Talisman Slot 1")
      set {_slotDesc} to eq_cc("&8Place an accessory here")
    else if {_i} is 43:
      set {_glass} to light gray stained glass pane
      set {_slotName} to eq_cc("&7Talisman Slot 2")
      set {_slotDesc} to eq_cc("&8Place an accessory here")
    # Player head slot - will be overwritten later
    else if {_i} is 22:
      set {_glass} to black stained glass pane
      set {_slotName} to eq_cc("&7Player Stats")
      set {_slotDesc} to eq_cc("&8View your stats here")
    # Close button slot - will be overwritten later
    else if {_i} is 49:
      set {_glass} to black stained glass pane
      set {_slotName} to eq_cc("&7Close Button")
      set {_slotDesc} to eq_cc("&8Click to close")
    # Empty slots
    else:
      set {_glass} to black stained glass pane
      set {_slotName} to eq_cc("&7Empty Slot")
      set {_slotDesc} to eq_cc("&8This slot is not used")
    
    # Set glass pane with hover text if we have a description
    if {_slotName} is not "":
      set name of {_glass} to {_slotName}
      set lore of {_glass} to {_slotDesc}
    else:
      set name of {_glass} to " "
    set slot {_i} of {_inv} to {_glass}
    add 1 to {_i}
  
  # Place actual items on top of glass (if they exist)
  if helmet of {_p} is set:
    set slot 10 of {_inv} to helmet of {_p}
  if chestplate of {_p} is set:
    set slot 19 of {_inv} to chestplate of {_p}
  if leggings of {_p} is set:
    set slot 28 of {_inv} to leggings of {_p}
  if boots of {_p} is set:
    set slot 37 of {_inv} to boots of {_p}
  
  if {equip::accessories::%{_u}%::necklace} is set:
    set slot 16 of {_inv} to {equip::accessories::%{_u}%::necklace}
  if {equip::accessories::%{_u}%::ring} is set:
    set slot 25 of {_inv} to {equip::accessories::%{_u}%::ring}
  if {equip::accessories::%{_u}%::talisman1} is set:
    set slot 34 of {_inv} to {equip::accessories::%{_u}%::talisman1}
  if {equip::accessories::%{_u}%::talisman2} is set:
    set slot 43 of {_inv} to {equip::accessories::%{_u}%::talisman2}
  
  set {eqGuiOpen::%{_u}%} to true
  
  # Get stats
  set {_hp} to {equip::hp::%{_u}%}
  if {_hp} is not set:
    set {_hp} to 0
  set {_mana} to {equip::mana::%{_u}%}
  if {_mana} is not set:
    set {_mana} to 0
  set {_speed} to {equip::speed::%{_u}%}
  if {_speed} is not set:
    set {_speed} to 0
  set {_fortune} to {equip::fortune::%{_u}%}
  if {_fortune} is not set:
    set {_fortune} to 0
  
  # Get base stats
  set {_baseHp} to {ha::hp::%{_u}%}
  if {_baseHp} is not set:
    set {_baseHp} to 50
  set {_baseMana} to {ha::mana::%{_u}%}
  if {_baseMana} is not set:
    set {_baseMana} to 100
  
  # Get level (from levels script)
  set {_level} to {level::%{_u}%}
  if {_level} is not set:
    set {_level} to 1
  
  # Calculate totals
  set {_totalHp} to {_baseHp} + {_hp}
  set {_totalMana} to {_baseMana} + {_mana}
  
  # Player head in center (slot 22) with stats on hover
  set {_head} to player head
  set name of {_head} to eq_cc("&f%name of {_p}%")
  set lore of {_head} to eq_cc("&8") and eq_cc("&7Level: &f%{_level}%") and eq_cc("&8") and eq_cc("&cHealth: &f%{_totalHp}% &7(&a+%{_hp}%&7)") and eq_cc("&9Mana: &f%{_totalMana}% &7(&9+%{_mana}%&7)") and eq_cc("&8") and eq_cc("&aMining Speed: &f%{_speed}%") and eq_cc("&bMining Fortune: &f%{_fortune}%") and eq_cc("&8") and eq_cc("&7Hover to view stats")
  set slot 22 of {_inv} to {_head}
  
  # Close button
  set slot 49 of {_inv} to barrier named eq_cc("&cClose") with lore eq_cc("&8") and eq_cc("&7Click to close the menu")
  
  set {equip::gui::%{_u}%} to true
  open {_inv} to {_p}

# ----------------------------
# Commands
# ----------------------------

command /equipment:
  trigger:
    eq_openEquipmentGui(player)

command /equip:
  trigger:
    eq_openEquipmentGui(player)

# ----------------------------
# GUI Click Handling
# ----------------------------

on inventory click:
  set {_u} to eq_uid(player)
  
  if {eqGuiOpen::%{_u}%} is true:
    # Check if clicking in player's own inventory (not GUI)
    if clicked inventory is player's inventory:
      stop
    
    # Check inventory name (use converted color code)
    set {_invName} to name of event-inventory
    if {_invName} is not set:
      stop
    if {_invName} is not eq_cc("&8Equipment"):
      stop
    
    set {_slotNum} to clicked slot
    if {_slotNum} is not set:
      stop
    
    # Close button
    if {_slotNum} is 49:
      cancel event
      close player's inventory
      delete {eqGuiOpen::%{_u}%}
      stop
    
    # Player head (slot 22) - just show stats, don't allow interaction
    if {_slotNum} is 22:
      cancel event
      stop
    
    # Equipment slots - handle armor equipping
    # Armor slots (10=helmet, 19=chestplate, 28=leggings, 37=boots) - actually equip to player
    cancel event
    
    if {_slotNum} is 10:
      # Helmet slot - get item from player's hand
      set {_itemToEquip} to tool of player
      set {_currentItem} to slot {_slotNum} of event-inventory
      
      # If holding an item, try to equip it
      if {_itemToEquip} is set:
        if {_itemToEquip} is not air:
          set {_itemType} to type of {_itemToEquip}
          set {_typeStr} to "%{_itemType}%"
          if {_typeStr} contains "helmet":
            set {_oldArmor} to helmet of player
            if {_oldArmor} is set:
              if {_oldArmor} is not air:
                give {_oldArmor} to player
            set helmet of player to {_itemToEquip}
            set tool of player to air
      # If clicking on existing item in slot (removing), unequip
      else if {_currentItem} is set:
        if {_currentItem} is not air:
          set {_oldArmor} to helmet of player
          if {_oldArmor} is set:
            if {_oldArmor} is not air:
              give {_oldArmor} to player
              set helmet of player to air
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    if {_slotNum} is 19:
      # Chestplate slot
      set {_itemToEquip} to tool of player
      set {_currentItem} to slot {_slotNum} of event-inventory
      
      if {_itemToEquip} is set:
        if {_itemToEquip} is not air:
          set {_itemType} to type of {_itemToEquip}
          set {_typeStr} to "%{_itemType}%"
          if {_typeStr} contains "chestplate":
            set {_oldArmor} to chestplate of player
            if {_oldArmor} is set:
              if {_oldArmor} is not air:
                give {_oldArmor} to player
            set chestplate of player to {_itemToEquip}
            set tool of player to air
      else if {_currentItem} is set:
        if {_currentItem} is not air:
          set {_oldArmor} to chestplate of player
          if {_oldArmor} is set:
            if {_oldArmor} is not air:
              give {_oldArmor} to player
              set chestplate of player to air
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    if {_slotNum} is 28:
      # Leggings slot
      set {_itemToEquip} to tool of player
      set {_currentItem} to slot {_slotNum} of event-inventory
      
      if {_itemToEquip} is set:
        if {_itemToEquip} is not air:
          set {_itemType} to type of {_itemToEquip}
          set {_typeStr} to "%{_itemType}%"
          if {_typeStr} contains "leggings":
            set {_oldArmor} to leggings of player
            if {_oldArmor} is set:
              if {_oldArmor} is not air:
                give {_oldArmor} to player
            set leggings of player to {_itemToEquip}
            set tool of player to air
      else if {_currentItem} is set:
        if {_currentItem} is not air:
          set {_oldArmor} to leggings of player
          if {_oldArmor} is set:
            if {_oldArmor} is not air:
              give {_oldArmor} to player
              set leggings of player to air
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    if {_slotNum} is 37:
      # Boots slot
      set {_itemToEquip} to tool of player
      set {_currentItem} to slot {_slotNum} of event-inventory
      
      if {_itemToEquip} is set:
        if {_itemToEquip} is not air:
          set {_itemType} to type of {_itemToEquip}
          set {_typeStr} to "%{_itemType}%"
          if {_typeStr} contains "boots":
            set {_oldArmor} to boots of player
            if {_oldArmor} is set:
              if {_oldArmor} is not air:
                give {_oldArmor} to player
            set boots of player to {_itemToEquip}
            set tool of player to air
      else if {_currentItem} is set:
        if {_currentItem} is not air:
          set {_oldArmor} to boots of player
          if {_oldArmor} is set:
            if {_oldArmor} is not air:
              give {_oldArmor} to player
              set boots of player to air
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    # Accessory slots - handle manually but allow dropping
    if {_slotNum} is 16:
      # Necklace slot - allow dropping
      set {_oldItem} to {equip::accessories::%{_u}%::necklace}
      set {_newItem} to slot {_slotNum} of event-inventory
      if {_newItem} is set:
        if {_newItem} is not air:
          if eq_isAccessory({_newItem}) is true:
            set {equip::accessories::%{_u}%::necklace} to {_newItem}
            if {_oldItem} is set:
              give {_oldItem} to player
          else:
            # Not an accessory - give back old item if exists
            if {_oldItem} is set:
              give {_oldItem} to player
        else:
          # Slot is empty - return old item
          if {_oldItem} is set:
            give {_oldItem} to player
            delete {equip::accessories::%{_u}%::necklace}
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    if {_slotNum} is 25:
      # Ring slot
      set {_oldItem} to {equip::accessories::%{_u}%::ring}
      set {_newItem} to slot {_slotNum} of event-inventory
      if {_newItem} is set:
        if {_newItem} is not air:
          if eq_isAccessory({_newItem}) is true:
            set {equip::accessories::%{_u}%::ring} to {_newItem}
            if {_oldItem} is set:
              give {_oldItem} to player
          else:
            if {_oldItem} is set:
              give {_oldItem} to player
        else:
          if {_oldItem} is set:
            give {_oldItem} to player
            delete {equip::accessories::%{_u}%::ring}
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    if {_slotNum} is 34:
      # Talisman 1 slot
      set {_oldItem} to {equip::accessories::%{_u}%::talisman1}
      set {_newItem} to slot {_slotNum} of event-inventory
      if {_newItem} is set:
        if {_newItem} is not air:
          if eq_isAccessory({_newItem}) is true:
            set {equip::accessories::%{_u}%::talisman1} to {_newItem}
            if {_oldItem} is set:
              give {_oldItem} to player
          else:
            if {_oldItem} is set:
              give {_oldItem} to player
        else:
          if {_oldItem} is set:
            give {_oldItem} to player
            delete {equip::accessories::%{_u}%::talisman1}
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    if {_slotNum} is 43:
      # Talisman 2 slot
      set {_oldItem} to {equip::accessories::%{_u}%::talisman2}
      set {_newItem} to slot {_slotNum} of event-inventory
      if {_newItem} is set:
        if {_newItem} is not air:
          if eq_isAccessory({_newItem}) is true:
            set {equip::accessories::%{_u}%::talisman2} to {_newItem}
            if {_oldItem} is set:
              give {_oldItem} to player
          else:
            if {_oldItem} is set:
              give {_oldItem} to player
        else:
          if {_oldItem} is set:
            give {_oldItem} to player
            delete {equip::accessories::%{_u}%::talisman2}
      wait 1 tick
      eq_recalcStats(player)
      eq_openEquipmentGui(player)
      stop
    
    # Lock all other slots
    cancel event
    stop

on inventory close:
  set {_u} to eq_uid(player)
  set {_invName} to name of event-inventory
  if {_invName} is eq_cc("&8Equipment"):
    # Update stats when closing
    wait 1 tick
    eq_recalcStats(player)
    delete {equip::gui::%{_u}%}
    delete {eqGuiOpen::%{_u}%}

# Recalculate stats periodically and on armor changes
every 5 seconds:
  loop all players:
    eq_recalcStats(loop-player)

# Recalculate stats when armor is changed in player inventory
on inventory click:
  if clicked inventory is player's inventory:
    set {_slotNum} to clicked slot
    if {_slotNum} is set:
      if {_slotNum} is 39:
        wait 2 ticks
        eq_recalcStats(player)
        stop
      if {_slotNum} is 38:
        wait 2 ticks
        eq_recalcStats(player)
        stop
      if {_slotNum} is 37:
        wait 2 ticks
        eq_recalcStats(player)
        stop
      if {_slotNum} is 36:
        wait 2 ticks
        eq_recalcStats(player)
        stop

# ----------------------------
# Integration with mining system
# ----------------------------

# Update mining speed from equipment
function ms_getEquipmentSpeed(p: player) :: number:
  set {_u} to eq_uid({_p})
  set {_speed} to {equip::speed::%{_u}%}
  if {_speed} is not set:
    return 0
  return {_speed}

# Update mining fortune from equipment
function ms_getEquipmentFortune(p: player) :: number:
  set {_u} to eq_uid({_p})
  set {_fortune} to {equip::fortune::%{_u}%}
  if {_fortune} is not set:
    return 0
  return {_fortune}

# ----------------------------
# Integration with health system
# ----------------------------

on load:
  loop all players:
    eq_recalcStats(loop-player)

on join:
  wait 2 ticks
  eq_recalcStats(player)

